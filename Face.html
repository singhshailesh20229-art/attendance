<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Face Recognition Attendance System</title>

<!-- FACE API -->
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

<style>
body{
    font-family: Arial;
    background:#f4f6f9;
}
.container{
    max-width:900px;
    background:#fff;
    margin:20px auto;
    padding:20px;
    border-radius:10px;
}
h1{text-align:center}
input,button{
    padding:10px;
    margin:5px;
}
button{
    background:#4CAF50;
    color:#fff;
    border:none;
    cursor:pointer;
    border-radius:5px;
}
button.danger{background:#e53935}
table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
}
th,td{
    border:1px solid #ccc;
    padding:8px;
    text-align:center;
}
video{
    border:2px solid #333;
    border-radius:5px;
}
#status{
    font-weight:bold;
    margin-top:10px;
}
</style>
</head>

<body>

<div class="container">
<h1>Face Recognition Attendance System</h1>

<h3>Student Details</h3>
<input id="sid" placeholder="Student ID">
<input id="name" placeholder="Student Name">

<h3>Camera</h3>
<video id="video" width="320" height="240" autoplay muted></video><br>
<button onclick="registerFace()">Register Face</button>
<button onclick="markByFace()">Mark Attendance by Face</button>
<p id="status"></p>

<h3>Attendance Records</h3>
<button onclick="downloadCSV()">Download CSV</button>
<button onclick="clearAll()" class="danger">Clear All</button>

<table>
<thead>
<tr>
<th>ID</th>
<th>Name</th>
<th>Date</th>
<th>Time</th>
<th>Status</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>

<script>
/* ---------------- DATA ---------------- */
let attendance = JSON.parse(localStorage.getItem("attendance")) || [];
let faces = JSON.parse(localStorage.getItem("faces")) || {};
const video = document.getElementById("video");
const statusTxt = document.getElementById("status");

/* ---------------- LOAD MODELS ---------------- */
Promise.all([
  faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/models"),
  faceapi.nets.faceLandmark68Net.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/models"),
  faceapi.nets.faceRecognitionNet.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/models")
]).then(startCamera);

/* ---------------- CAMERA ---------------- */
function startCamera(){
    navigator.mediaDevices.getUserMedia({video:true})
    .then(stream => video.srcObject = stream)
    .catch(()=>alert("Camera permission denied"));
}

/* ---------------- REGISTER FACE ---------------- */
async function registerFace(){
    let sid = document.getElementById("sid").value.trim();
    let name = document.getElementById("name").value.trim();
    if(!sid || !name){
        alert("Enter ID & Name");
        return;
    }

    const detection = await faceapi
        .detectSingleFace(video,new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptor();

    if(!detection){
        statusTxt.innerText="❌ Face not detected";
        return;
    }

    faces[sid] = {
        name:name,
        descriptor:Array.from(detection.descriptor)
    };

    localStorage.setItem("faces",JSON.stringify(faces));
    statusTxt.innerText="✅ Face Registered Successfully";
}

/* ---------------- FACE MATCH & ATTENDANCE ---------------- */
async function markByFace(){
    const detection = await faceapi
        .detectSingleFace(video,new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptor();

    if(!detection){
        statusTxt.innerText="❌ Face not detected";
        return;
    }

    let matchedId = null;
    let minDistance = 1;

    for(let id in faces){
        let saved = new Float32Array(faces[id].descriptor);
        let dist = faceapi.euclideanDistance(saved,detection.descriptor);
        if(dist < minDistance){
            minDistance = dist;
            matchedId = id;
        }
    }

    if(matchedId && minDistance < 0.6){
        markAttendance(matchedId, faces[matchedId].name);
        statusTxt.innerText="✅ Face Matched | Attendance Marked";
    }else{
        statusTxt.innerText="❌ Face Not Matched";
    }
}

/* ---------------- ATTENDANCE ---------------- */
function markAttendance(id,name){
    let today = new Date().toLocaleDateString();
    if(attendance.find(a=>a.id===id && a.date===today)) return;

    let now = new Date();
    attendance.push({
        id:id,
        name:name,
        date:today,
        time:now.toLocaleTimeString(),
        status:"Present"
    });

    save();
}

function display(){
    let rows="";
    attendance.forEach(a=>{
        rows+=`
        <tr>
        <td>${a.id}</td>
        <td>${a.name}</td>
        <td>${a.date}</td>
        <td>${a.time}</td>
        <td>${a.status}</td>
        </tr>`;
    });
    document.getElementById("list").innerHTML=rows;
}

function save(){
    localStorage.setItem("attendance",JSON.stringify(attendance));
    display();
}

/* ---------------- CSV ---------------- */
function downloadCSV(){
    let csv="ID,Name,Date,Time,Status\n";
    attendance.forEach(a=>{
        csv+=`${a.id},${a.name},${a.date},${a.time},${a.status}\n`;
    });
    let b=new Blob([csv]);
    let a=document.createElement("a");
    a.href=URL.createObjectURL(b);
    a.download="attendance.csv";
    a.click();
}

/* ---------------- CLEAR ---------------- */
function clearAll(){
    if(confirm("Clear all data?")){
        attendance=[];
        faces={};
        localStorage.clear();
        display();
    }
}

display();
</script>

</body>
</html>
